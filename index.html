<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Nim playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Titillium+Web" rel="stylesheet">
    <link href='styles.css' rel='stylesheet' type='text/css'>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/nim/nim.js"></script>
    <script type="text/javascript" src="purify.min.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/dracula.css">
</head>

<body>
<div class="container">
  <div class="header">
    <a class="logo" href="https://nim-lang.org"><img src="logo.svg"/>Playground</a>
  </div>
  <div class="body">
    <div class="explanations">
      <div>
        <section>
          <h1>Welcome to a tour of Nim</h1>
          <p>In this tour we'll go through some of the different aspects of the Nim programming language so you can get to know it better.
          If you are considering to try Nim out, but don't want to download anything, this is a great way to get a little more insight.</p>
          <p>Throughout the tour there will be code snippets like the one you see to the right. To run these snippets you can hit the "Run!"
          button below the code window. This will compile the code on a server, and show you the output of the compilation, along with the
          output of your program.</p>
          <p>The gray button next to the run button allows you to switch between the compilation output, and the execution output. When your
          code has an error it will automatically switch to the compilation output.</p>
          <p>But enough talking! Try to run the code snippet on the right, and hit the "Next" button below this text when you're ready for more.</p>
        </section>
      </div>
      <div class="buttons bottom">
        <span class="info" id="info">1/5: Welcome to a tour of Nim</span>
        <button class="button prev" id="outputButton" onclick="currentPage--;showPage();">Previous</button>
        <button class="button next" id="runbutton" onclick="currentPage++;showPage();">Next</button>
      </div>
    </div>
    <div class="code">
      <div id="editor"></div>
      <div id="output">
        <div class="buttons">
          <button class="button share" id="sharebutton" href="#" onclick="shareCode()">Share via ix</button>
          <button class="button output" id="outputButton" href="#" onclick="switchOutput()">Showing: output</button>
          <button class="button run" id="runbutton" href="#" onclick="runCode()">Run!</button>
        </div>
        <div class="content" id="logs">
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var myCodeMirror = CodeMirror(document.getElementById("editor"), {
    mode: "nim",
    value: "",
    tabSize: 2,
    lineNumbers: true,
    theme: "dracula"
  });
  var urlParams;
  var currentPage = 0;
  (window.onload = function () {
      var match,
          pl     = /\+/g,  // Regex for replacing addition symbol with a space
          search = /([^&=]+)=?([^&]*)/g,
          decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
          query  = window.location.search.substring(1);

      urlParams = {};
      while (match = search.exec(query))
         urlParams[decode(match[1])] = decode(match[2]);
      if("ix" in urlParams) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            outputMsg = "http://ix.io/" + urlParams["ix"] + "/nim";
            debugMsg = "";
            setOutput(true);
            myCodeMirror.setValue(this.responseText);
          }
        };
        xhttp.open("GET", "/ix/" + urlParams["ix"], true);
        xhttp.send(null);
      }
      var explanations = document.getElementsByClassName("explanations")[0].children[0]
      if(!("tour" in urlParams)) {
        explanations.classList.remove("explanations");
        document.getElementsByClassName("code")[0].classList.remove("code");
      } else {
        explanations.innerHTML = DOMPurify.sanitize("<section onload='alert(\'hello world\');'><h1>First page</h1>hello world<code>echo \"Hello world\"</code></section><section><h1>Second page</h1>Second try<code>echo \"Hello worldier\"</code></section><section><code>This only has code</code></section><section><h1>This doesn't have code</h1><p>Hello world</p></section>");
        showPage();
      }
  })();

  function showPage() {
    var explanations = document.getElementsByClassName("explanations")[0].children[0]
    if (currentPage >= explanations.children.length) {
      currentPage = explanations.children.length - 1;
    }
    if (currentPage < 0) {
      currentPage = 0;
    }
    outputMsg = "";
    debugMsg = "";
    document.getElementById("info").innerText = "";
    myCodeMirror.setValue("");
    for (var i = 0; i < explanations.children.length; i++) {
      var elem = explanations.children[i];
      if(elem.nodeName != "SECTION") {
        explanations.removeChild(elem);
      } else {
        if(i != currentPage) {
          elem.style.display = "none";
        } else {
          elem.style.display = "block";
          var headings = elem.getElementsByTagName("h1");
          if (headings.length != 0) {
            var name = headings[0].innerText;
            document.getElementById("info").innerText = (currentPage + 1) + "/" + explanations.children.length + ": " + name;
          } else {
            document.getElementById("info").innerText = (currentPage + 1) + "/" + explanations.children.length + ": " + "<No title>";
          }
          var codeElements = elem.getElementsByTagName("code")
          if (codeElements.length != 0) {
            myCodeMirror.setValue(codeElements[codeElements.length - 1].innerText);
            codeElements[codeElements.length - 1].style.display = "none";
          }
        }
      }
    }
  }

  function updateURLParameter(url, param, paramVal){
      var newAdditionalURL = "";
      var tempArray = url.split("?");
      var baseURL = tempArray[0];
      var additionalURL = tempArray[1];
      var temp = "";
      if (additionalURL) {
          tempArray = additionalURL.split("&");
          for (var i=0; i<tempArray.length; i++){
              if(tempArray[i].split('=')[0] != param){
                  newAdditionalURL += temp + tempArray[i];
                  temp = "&";
              }
          }
      }

      var rows_txt = temp + "" + param + "=" + paramVal;
      return baseURL + "?" + newAdditionalURL + rows_txt;
  }

  var output = "output";
  var outputMsg = "";
  var debugMsg = "";
  function runCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var messages = JSON.parse(this.responseText);
        outputMsg = messages.log;
        debugMsg = messages.compileLog.replace(/\n/g,"<br/>").replace(/\[[^\]]*\]/g, function (x) {
          return "<span class=\"brackets\">" + x + "</span>"
        }).replace(/Hint: /g, "<span class=\"hint\">Hint: </span>").replace(
          /nimcode.nim\(.*\) Error: /g, function (x) {
          return x.replace("Error: ", "<span class=\"error\">Error: </span>")
        });
        setOutput();
        document.getElementById("runbutton").classList.remove("is-loading");
      }
    };
    xhttp.open("POST", "/compile", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compilationTarget\":\"c\"}");
    document.getElementById("runbutton").classList.add("is-loading");
  }
  function shareCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        outputMsg = this.responseText;
        debugMsg = "";
        output = "output";
        setOutput(true);
        document.getElementById("sharebutton").classList.remove("is-loading");
        window.history.pushState(null, null, updateURLParameter(document.location.href, "ix", this.responseText.slice(13, 17)));
      }
    };
    xhttp.open("POST", "/ix", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compilationTarget\":\"c\"}");
    document.getElementById("sharebutton").classList.add("is-loading");
  }
  function switchOutput() {
    if(output == "output") {
      output = "debug";
    } else {
      output = "output";
    }
    setOutput(true);
  }
  function setOutput(force = false) {
    if(output == "output" && (outputMsg != "\n" || force == true)) {
      document.getElementById("logs").innerText = outputMsg;
      document.getElementById("outputButton").innerText = "Showing: output";
      output = "output";
    } else {
      document.getElementById("logs").innerHTML = debugMsg;
      document.getElementById("outputButton").innerText = "Showing: debug";
      output = "debug";
    }
  }
</script>
</body>
</html>

