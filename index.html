<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Nim playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link href='styles.css' rel='stylesheet' type='text/css'>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/nim/nim.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/dracula.css">
</head>

<body>
<div class="container">
  <div class="header">
    <a class="logo" href="https://nim-lang.org"><img src="logo.svg"/>Playground</a>
  </div>
  <div class="body">
    <div id="editor"></div>
    <div id="output">
      <div class="buttons">
        <button class="button share" id="sharebutton" href="#" onclick="shareCode()">Share via ix</button>
        <button class="button output" id="outputButton" href="#" onclick="switchOutput()">Showing: output</button>
        <button class="button run" id="runbutton" href="#" onclick="runCode()">Run!</button>
      </div>
      <div class="content" id="logs">
      </div>
    </div>
  </div>
</div>
<script>
  var myCodeMirror = CodeMirror(document.getElementById("editor"), {
    mode: "nim",
    value: "",
    tabSize: 2,
    lineNumbers: true,
    theme: "dracula"
  });
  var urlParams;
  (window.onload = function () {
      var match,
          pl     = /\+/g,  // Regex for replacing addition symbol with a space
          search = /([^&=]+)=?([^&]*)/g,
          decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
          query  = window.location.search.substring(1);

      urlParams = {};
      while (match = search.exec(query))
         urlParams[decode(match[1])] = decode(match[2]);
      if("ix" in urlParams) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            outputMsg = "http://ix.io/" + urlParams["ix"] + "/nim";
            debugMsg = "";
            setOutput(true);
            myCodeMirror.setValue(this.responseText);
          }
        };
        xhttp.open("GET", "/ix/" + urlParams["ix"], true);
        xhttp.send(null);
      }
  })();

  function updateURLParameter(url, param, paramVal){
      var newAdditionalURL = "";
      var tempArray = url.split("?");
      var baseURL = tempArray[0];
      var additionalURL = tempArray[1];
      var temp = "";
      if (additionalURL) {
          tempArray = additionalURL.split("&");
          for (var i=0; i<tempArray.length; i++){
              if(tempArray[i].split('=')[0] != param){
                  newAdditionalURL += temp + tempArray[i];
                  temp = "&";
              }
          }
      }

      var rows_txt = temp + "" + param + "=" + paramVal;
      return baseURL + "?" + newAdditionalURL + rows_txt;
  }

  var output = "output";
  var outputMsg = "";
  var debugMsg = "";
  function runCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var messages = JSON.parse(this.responseText);
        outputMsg = messages.log;
        debugMsg = messages.compileLog.replace(/\n/g,"<br/>").replace(/\[[^\]]*\]/g, function (x) {
          return "<span class=\"brackets\">" + x + "</span>"
        }).replace(/Hint: /g, "<span class=\"hint\">Hint: </span>").replace(
          /nimcode.nim\(.*\) Error: /g, function (x) {
          return x.replace("Error: ", "<span class=\"error\">Error: </span>")
        });
        setOutput();
        document.getElementById("runbutton").classList.remove("is-loading");
      }
    };
    xhttp.open("POST", "/compile", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compilationTarget\":\"c\"}");
    document.getElementById("runbutton").classList.add("is-loading");
  }
  function shareCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        outputMsg = this.responseText;
        debugMsg = "";
        output = "output";
        setOutput(true);
        document.getElementById("sharebutton").classList.remove("is-loading");
        window.history.pushState(null, null, updateURLParameter(document.location.href, "ix", this.responseText.slice(13, 17)));
      }
    };
    xhttp.open("POST", "/ix", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compilationTarget\":\"c\"}");
    document.getElementById("sharebutton").classList.add("is-loading");
  }
  function switchOutput() {
    if(output == "output") {
      output = "debug";
    } else {
      output = "output";
    }
    setOutput(true);
  }
  function setOutput(force = false) {
    if(output == "output" && (outputMsg != "\n" || force == true)) {
      document.getElementById("logs").innerText = outputMsg;
      document.getElementById("outputButton").innerText = "Showing: output";
      output = "output";
    } else {
      document.getElementById("logs").innerHTML = debugMsg;
      document.getElementById("outputButton").innerText = "Showing: debug";
      output = "debug";
    }
  }
</script>
</body>
</html>

