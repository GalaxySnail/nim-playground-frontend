<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Nim playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link href='styles.css' rel='stylesheet' type='text/css'>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/nim/nim.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/dracula.css">
</head>

<body>
<div class="container">
  <div class="header">
      <a class="logo" href="/list"><img src="logo.svg"/>Playground</a>
  </div>
  <div class="body">
    <div id="editor"></div>
    <div id="output">
      <div class="buttons">
        <a class="button share" href="#" onclick="alert('hello world');">Share via ix</a>
        <a class="button output" id="outputButton" href="#" onclick="switchOutput()">Showing: output</a>
        <a class="button run" id="runbutton" href="#" onclick="runCode()">Run!</a>
      </div>
      <div class="content" id="logs">
      </div>
    </div>
  </div>
</div>
<script>
  var myCodeMirror = CodeMirror(document.getElementById("editor"), {
    mode: "nim",
    value: "echo \"Hello world\"",
    tabSize: 2,
    lineNumbers: true,
    theme: "dracula"
  });
  var output = "output";
  var outputMsg = "";
  var debugMsg = "";
  function runCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var messages = JSON.parse(this.responseText);
        outputMsg = messages.log;
        debugMsg = messages.compileLog.replace(/\n/g,"<br/>").replace(/\[[^\]]*\]/g, function (x) {
          return "<span class=\"brackets\">" + x + "</span>"
        }).replace(/Hint: /g, "<span class=\"hint\">Hint: </span>").replace(
          /nimcode.nim\(.*\) Error: /g, function (x) {
          return x.replace("Error: ", "<span class=\"error\">Error: </span>")
        });
        setOutput();
        document.getElementById("runbutton").classList.remove("is-loading");
      }
    };
    xhttp.open("POST", "/compile", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compilationTarget\":\"c\"}");
    document.getElementById("runbutton").classList.add("is-loading");
  }
  function switchOutput() {
    if(output == "output") {
      output = "debug";
    } else {
      output = "output";
    }
    setOutput(true);
  }
  function setOutput(force = false) {
    if(output == "output" && (outputMsg != "" || force == true)) {
      document.getElementById("logs").innerText = outputMsg;
      document.getElementById("outputButton").innerText = "Showing: output";
      output = "output";
    } else {
      document.getElementById("logs").innerHTML = debugMsg;
      document.getElementById("outputButton").innerText = "Showing: debug";
      output = "debug";
    }
  }
</script>
</body>
</html>

