<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>A Tour of Nim</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link href='styles.css' rel='stylesheet' type='text/css'>
    <script src="codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <script src="codemirror/mode/python/python.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
      <a class="logo" href="/list"><img src="logo.svg"/> A Tour of Nim</a>
  </div>
  <div class="body">
    <div class="explanations">
      <div class="content" id="content">
        Hello
      </div>
      <div class="buttons bottom">
          <span id="navigation">Test</span>
          <a class="button prev" href="#" onclick="pagenum-=1; setPage();">Prev</a>
          <a class="button next" href="#" onclick="pagenum+=1; setPage();">Next</a>
      </div>
    </div>
    <div class="code">
      <div id="editor"></div>
      <div id="output">
        <div class="buttons">
          <a class="button output" id="outputButton" href="#" onclick="switchOutput()">Showing: output</a>
          <a class="button run" href="#" onclick="runCode()">Run!</a>
        </div>
        <div class="content" id="logs">
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var myCodeMirror = CodeMirror(document.getElementById("editor"), {
    mode: "python",
    value: "function hello() {system.prinln(\"Hello world\");",
    tabSize: 2,
    lineNumbers: true
  });
  var pagenum = 0;
  var data = [
    {
      "title": "Welcome",
      "content": "Welcome to a tour of Nim!",
      "code": "echo 100"
    },
    {
      "title": "Second page",
      "content": "Welcome to a tour of Nim, part 2!",
      "code": "echo 200"
    },
  ];
  setPage();
  var output = "output";
  var outputMsg = "";
  var debugMsg = "";
  function runCode() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var messages = JSON.parse(this.responseText);
        outputMsg = messages.log;
        debugMsg = messages.compileLog.replace(/\n/g,"<br/>").replace(/\[[^\]]*\]/g, function (x) {
          return "<span class=\"brackets\">" + x + "</span>"
        }).replace(/Hint: /g, "<span class=\"hint\">Hint: </span>").replace(
          /nimcode.nim\(.*\) Error: /g, function (x) {
          return x.replace("Error: ", "<span class=\"error\">Error: </span>")
        });
        setOutput();
      }
    };
    xhttp.open("POST", "http://lvh.me:5000/compile", true);
    xhttp.setRequestHeader("Content-type", "text/plain");
    xhttp.send("{\"code\":" + JSON.stringify(myCodeMirror.getValue()) + ", \"compileTarget\":\"c\"}");
  }
  function switchOutput() {
    if(output == "output") {
      output = "debug";
    } else {
      output = "output";
    }
    setOutput(true);
  }
  function setOutput(force = false) {
    if(output == "output" && (outputMsg != "" || force == true)) {
      document.getElementById("logs").innerText = outputMsg;
      document.getElementById("outputButton").innerText = "Showing: output";
      output = "output";
    } else {
      document.getElementById("logs").innerHTML = debugMsg;
      document.getElementById("outputButton").innerText = "Showing: debug";
      output = "debug";
    }
  }
  function setPage() {
    if(pagenum <0) pagenum = 0;
    if(pagenum >= data.length) pagenum = data.length - 1;
    document.getElementById("content").innerHTML = "<h1>" + data[pagenum].title + "</h1><p>" + data[pagenum].content + "</p";
    document.getElementById("navigation").innerText = (pagenum + 1) + "/" + data.length + ": " + data[pagenum].title;
    myCodeMirror.setValue(data[pagenum].code);
    outputMsg = "";
    debugMsg = "";
    output = "output";
    setOutput(true);
  }
</script>
</body>
</html>

